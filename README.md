# Дипломный проект по программе обучения на DevOps инженера в TeachMeSkills

## Задание на дипломный проект:
```
В дипломном проекте должно быть реализовано:
* выбран общедоступный репозиторий или несколько репозиториев с исходным кодом приложения,
состоящего из одного или нескольких микросервисов;
* выполнен fork или сделана копия репозитория;
* автоматизировано создание инфраструктуры для развертывания проекта;
* автоматизированы процессы CI/CD;
* настроен мониторинг инфраструктуры и приложения.

Критерии выполнения:
* Репозитории должен содержать минимальную документацию, описывающую
содержимое и процессы сборки и развертывания;
* Инфраструктура должна разворачиваться с нуля запуском одной команды.
Все должно быть реализовано по принципам IaC;
* CI/CD:
    o при коммите в любую ветку репозитория должны запускаться этапы проверки кода линтером, сборки исходного кода,
автотесты собранного приложения и загрузка артефактов в хранилище;
    o при коммите в основную ветку (master/main) дополнительно должен запускаться
автоматический deployment на целевую инфраструктуру;
    o Должно отправляться уведомление о результате сборки и развертывания в любой
канал (почта, чат).

Дополнительные (опциональные) варианты улучшения проекта:
* Реализация SSL/TLS;
* Масштабируемость (несколько реплик одного сервиса с балансировщиком);
* Контейнеризация;
* Kubernetes в качестве целевой инфраструктуры;
* Больше типов и количества тестов (интеграционное, нагрузочное и пр.);
* Автоматическая настройка всего (включая CI\CD, мониторинг) с нуля;
* Мониторинг инфраструктуры и приложения;
* Реализация Log-aggregation;
* Документированный код.

Применяемые инструменты:
* Развертывание инфраструктуры: Terraform, AWS, EKS, Ansible, Docker, Vagrant;
* CI/CD: Jenkins, Github Actions;
* Оповещение: Email, Telegram, Slack, Discord;
* Мониторинг: Prometheus, Grafana;
* Логирование: ELK.

Защита проекта:
* Краткая презентация с описанием проекта, примененными инструментами, проделанной работы
и полученными результатами (3-5 мин.);
* Демонстрация CI/CD (10-12 мин.);
* Вопросы и обсуждение (5-7 мин.).
```

## Технологии применяемые для реализации проекта:
- Ansible
- Docker
- Docker Compose
- Docker Hub
- Google Cloud Platform
- Google Kubernetis Engine
- Terraform
- GitHub
- Jenkins
- Nginx
- Certbot
- Ingress nginx controller
- Cert-manager kubernetes
- Prometheus
- Grafana

## Описание реализованного проекта
Проект состоит из двух состовляющих:
- Подготовка, развертывание инфраструктуры
- Автоматизация процессов развертывания на этапе разработки и поддержки приложения для нашего учебного проекта

## Подготовка и развертывание инфраструктуры
Фаилы для подготовки и развертывания инфраструктуры хранятся в директории `infrastructure`

**Используемые технологии для построения инфраструктуры проекта:**
- Jenkins
- Ansible
- Nginx
- Certbot
- Jenkins Agent
- Выделенное доменное имя
- Google Kubernetes Engine (GKE)
- Google Cloud Storage (Bucket)
- Ingress Nginx Controller для Kubernetes
- Cert Manager для Kubernetes
- Telegram бот
- Prometheus
- Grafana

***Jenkins***

Для развертывания Jenkins используется Ansible, который выполняет установку на отдельный VPS. В playbook описаны все этапы, позволяющие автоматически развернуть Jenkins с использованием Ansible и восстановить все настройки из архива данных jenkins_volume. 

Процесс включает:
* Установку Docker и всех зависимостей.
* Создание нового volume для хранения данных.
* Загрузку данных настроек Jenkins из архива в volume.
* Скачивание образа Jenkins и запуск контейнера Docker.
* Установку Nginx и Certbot.
* Настройку конфигурации Nginx для добавления собственного доменного имени для автоматического выпуска сертификата Let's Encrypt.

Данные настроек хранятся в файле `jenkins_home.tar.gz`.

Подробный процесс развертывания описан в файле `README.md` по пути `/infrastructure/deploy_jenkins`.

***Jenkins Agent***

Для развертывания Agent используется Ansible, который выполняет установку на отдельный VPS. В playbook описаны все этапы, включая подключение агента к Jenkins и установку всех зависимостей, которые будут использоваться при работе pipeline в нашем проекте. 

Пример устанавливаемых зависимостей: 
- git
- docker
- docker compose
- java
- google sdk
- kubectl
- helm
- node.js
- HTMLlint
- т.д.

Подробный процесс развертывания описан в файле `README.md` по пути `/infrastructure/deploy_jenkins_agent`.

***Выделенное доменное имя***

Приобретено доменное имя `hitmouz.com` для настройки инфраструктуры и использования в нашем учебном проекте.

***Google Bucket***

Создается bucket для последующего хранения состояния Terraform (tfstate).

Подробный процесс развертывания описан в файле `README.md` по пути `/infrastructure/deploy_k8s_ingress_cert`.

***Google Kubernetes Engine***

Для развертывания k8s используется Terraform, который разворачивает кластер в Google Cloud.

Подробный процесс развертывания описан в файле `README.md` по пути `/infrastructure/deploy_k8s_ingress_cert`.

***Ingress Nginx Controller for Kubernetes***

Для управления трафиком в k8s разворачивается Ingress Nginx Controller for Kubernetes.

Подробный процесс развертывания описан в файле `README.md` по пути `/infrastructure/deploy_k8s_ingress_cert`.

***Cert Manager for Kubernetes***

Для управления SSL сертификатами разворачивается и настраивается Cert Manager for Kubernetes.


Подробный процесс развертывания описан в файле `README.md` по пути `/infrastructure/deploy_k8s_ingress_cert`.

***Telegram бот***

Для получения оповещений о удачном (не удачном) выполененний pipeline создан telegram bot c помощью BotFather.

***Prometheus with Grafana***

Для базового мониторинга разворачивается и используется Prometheus с Grafanой в виде kube-prometheus-stack

Подробный процесс развертывания описан в файле `README.md` по пути `/infrastructure/deploy_k8s_prometheus`.

## Автоматизация процессов развертывания на этапе разработки и поддержки приложения для нашего учебного проекта

В нашем учебном проекте в качестве приложения будет использоваться созданнная html страничка, которая расположена в каталоге `app`. В каталоге `k8s-helm-diplom` созданы helm chart для запуска созданного image в кластере Kubernetis. Так же есть отдельная папка `k8s-manifest-diplom` c манифестами.
В файле `jenkinsfile.groovy` написан pipeline, в котором описывается весь процесс автоматизации сборки, тестирования и развертывания приложения с помощью helm chart в средах `stage` и `prod`

Проект состоит из двух веток: `main` и `dev`.

***Ветка [dev]***\
Ветка dev предназначена для разработчиков. В ветке dev выполняются следующие шаги:

- Происходит определение названия текущей ветки Git
- Этап автоматического извлечения кода из системы управления версиями и определение автора запуска pipeline.
- Происходит загрузка файлов из GitHub на агент, за исключением папки `infrastructure`.
- Осуществляется проверка корректности синтаксиса HTML-страниц с использованием HTMLHint.
- Создается Docker-образ на основе файла Dockerfile.
- С помощью Docker Compose запускается контейнер из созданного образа.
- Проверяется доступность страницы с помощью команды `curl`. Используется цикл, который выполняется 10 раз.
- Созданный образ загружается в репозиторий Docker Hub.
- Контейнер останавливается с помощью команды Docker Compose down, и временная директория с файлами, загруженными из GitHub, очищается.
- Происходит деплой в Google Cloud Kubernetes в среду `stage` c помощью Helm.
- Отправляются уведомления в Telegram об успешном или неуспешном развертывании в Kubernetes.

***Ветка [main]***\
Ветка main предназначена для prod среды. В ветке dev выполняются следующие шаги:

- Происходит определение названия текущей ветки Git
- Этап автоматического извлечения кода из системы управления версиями и определение автора запуска pipeline.
- Происходит загрузка файлов из GitHub на агент, за исключением папки `infrastructure`.
- Осуществляется проверка корректности синтаксиса HTML-страниц с использованием HTMLHint.
- Создается Docker-образ на основе файла Dockerfile.
- С помощью Docker Compose запускается контейнер из созданного образа.
- Проверяется доступность страницы с помощью команды `curl`. Используется цикл, который выполняется 10 раз.
- Созданный образ загружается в репозиторий Docker Hub.
- Контейнер останавливается с помощью команды Docker Compose down, и временная директория с файлами, загруженными из GitHub, очищается.
- Происходит деплой в Google Cloud Kubernetes в среду `prod` c помощью Helm. Требуется подтверждение продолжения работы pipeline на стадии Deploy to GKE prod для deploy k8s  
- Отправляются уведомления в Telegram об успешном или неуспешном развертывании в Kubernetes.

***Описание процесса работы в ветках***

*Для правильной работы pipeline в Jenkins в ветке `dev` необходимо выполнить следующие шаги:*
1. Внести изменения версии в файл `VERSION`. Этот файл автоматически подставляет номер версии в tag Docker-образа и в параметр tag в values-stage.yaml Helm chart.
2. Внести необходимые изменения в папке приложения app.
3. Выполнить `git push origin dev` для отправки изменений в удалённый репозиторий.
4. Запустить выполнение pipeline `mysite-diplom-stage` в Jenkins.
5. Открыть страничку `stage.hitmouz.com`, чтобы проверить результаты деплоя.

*Для правильной работы pipeline в Jenkins в ветке `main` необходимо выполнить следующие шаги:*
1. Выполнить merge ветки main следующими командами `git checkout main`, потом `git merge dev`, далее `git push origin main`.
2. При попадании кода в репозиторий, запуститься автоматическое выполнение pipeline `mysite-diplom-prod` в Jenkins
3. Зайти в pipeline `mysite-diplom-prod` в Jenkins и на этапе `Deploy to GKE prod` подтвердить выполнение.
4. Открыть страничку `prod.hitmouz.com`, чтобы проверить результаты деплоя.
   
Эти шаги обеспечивают автоматическое обновление версии и корректную работу приложения на этапах разработки и продакшн.

## Уведомления

Уведомления о выполнении или ошибке в работе Jenkins Pipeline отправляются через Telegram бота. 

Каждое уведомление включает в себя следующие данные:
- Название репозитория на GitHub.
- Ветку репозитория, на которой была выполнена сборка.
- Имя пользователя, запустившего сборку. Если сборка была запущена автоматически через Pipeline, это будет пользователь GitHub. В случае ручного запуска Pipeline пользователь Jenkins.
- Состояние сборки, указывающее на успешное выполнение или наличие ошибок.

Пример уведомления:

![Screenshot_85](https://github.com/hitmouz/diplom/assets/95587607/2c50f3ef-9456-43ea-8812-03d7e1649d85)


## Мониторинг

Мониторинг нашего кластера k8s осущевствляется с помощью базовой конфигурации Prometheus c Grafanой

Пример страницы мониторинга:

![Screenshot_83](https://github.com/hitmouz/diplom/assets/95587607/3f80b804-3f6a-46c8-992c-7b7c1fab16d5)

